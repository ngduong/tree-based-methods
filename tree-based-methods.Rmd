---
title: "tree-based-methods"
author: "Ngoc Duong"
date: "4/20/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lasso2)
library(tidyverse)
library(ISLR)
library(caret)
library(rpart)
library(rpart.plot)
library(party)
library(partykit)
library(randomForest)
library(ranger)
library(gbm)
library(plotmo)
library(pdp)
library(lime)
```


### Problem 1

```{r}
data("Prostate") #import data
```

**a. Fit a regression tree with "lpsa" as the response and the other variables as predictors**

```{r}
set.seed(13)
tree1 <-rpart(formula = lpsa~., data = Prostate)
rpart.plot(tree1)
```

Next, we can use cross-validation to determine the optimal tree.

```{r}
cpTable <-printcp(tree1)
plotcp(tree1)
```

We can prune the tree based on the cp table 

```{r}
minErr <-which.min(cpTable[,4]) # minimum cross-validation error
tree2 <-prune(tree1, cp = cpTable[minErr,1])

tree3 <-prune(tree1, cp = cpTable[cpTable[,4]<cpTable[minErr,4]+cpTable[minErr,5],1][1])# 1SE rule
```

The tree size corresponding to the lowest cross-validation error is 7 (splits), compared to 5 splits in the tree obtained by the 1SE rule. 

**b. Plot the final tree choice (7 splits), and interpret a terminal node**

```{r}
rpart.plot(tree2)
```

Looking at the fifth terminal node from the left, we can interpret it as: the predicted log(prostate specific antigen) is 2.3 for log(cancer volume) between -0.48 and 0.82 and log(prostate weight) more than 3.7. The number of observations satisfying all the above conditions and fall into this category is 10% of the total observations. 

**c. Perform bagging and report the variable importance**

```{r}
set.seed(13)
bagging = ranger(lpsa ~ ., data = Prostate, mtry = 8,
             splitrule = "variance", min.node.size = 5,
             importance = "permutation",
             scale.permutation.importance = TRUE)
```

We can look at the lpsa prediction for first 10 subjects in the dataset using model obtained from bagging
```{r}
predict(bagging, data = Prostate[1:10,])$predictions

#variable importance
barplot(sort(ranger::importance(bagging), decreasing = FALSE),
        las = 2, horiz = TRUE, cex.names = 0.7,
        col = colorRampPalette(colors = c("darkred","white","darkblue"))(8))
```

The variable importance above was computed from permuting out-of-bag data, suggesting log(cancer volume) and log(prostate weight) have the most influence in the fitted models. This can also be seen from the chosen decision tree in part b. On the other hand, age, log(capsular penetration), and log(benign prostatic hyperplasia amount) carry the least importance in the fitted models.

**d. Perform random forest and report the variable importance**

```{r}
set.seed(13)
#fast implementation
rf <-ranger(lpsa~., Prostate, mtry = 3) #decorrelate by picking mtry = 1/3 mtry in bagging 
```

We can also look at the lpsa prediction for first 10 subjects in the dataset using model obtained from random forest

```{r}
#prediction
predict(rf, data = Prostate[1:10,])$predictions

#importance importance


```


**e. Perform boosting and report variable importance**

```{r}

```


**f. Final choice of model for PSA level prediction**


